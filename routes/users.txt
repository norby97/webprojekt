 const express = require('express');
 const router = express.Router();
 const passport = require('passport');
 const jwt = require('jsonwebtoken');
 const User = require('../models/user');
 const config = require('../config/database');

 //regisztracio
 router.post('/register',(req ,res, next) =>{
   let ujFelhasznalo = new User ({
      nev: req.body.nev,

      felhasznalonev: req.body.felhasznalonev,
      email : req.body.email,
      jelszo : req.body.jelszo,
      pontszam : 0,
      admin : 0
   });
    User.addUser(ujFelhasznalo, (err) =>{
     if(err) res.json({succes : false, msg:'Unsuccesfull registration!!!'});
        else res.json({succes : true, msg:'Succesfull registration!!!'});
   });

 });

//login
router.post('/login',(req ,res, next) =>{
  const felhasznalonev = req.body.felhasznalonev;
  const jelszo = req.body.jelszo;

  User.getUserByUsername(felhasznalonev , (err, felhasznalo) => {
    if(err) throw err;
    //ha nem letezik a felahasznalo akkor uzenetet kuldunk vissz ellenben checkoljuk a jelszavat
    if(!felhasznalo) return res.json({succes:false, msg:"Wrong username!!!"});

    User.jelszoEllenorzes(jelszo, felhasznalo.jelszo, (err, ok) => {
      if(err) throw err;
      if(ok)
      {
        const token = jwt.sign({data: felhasznalo}, config.secret,{
            expiresIn: 3600  //1 ora mulva lejar a session
        });
        res.json({
          succes: true,
          token: 'JWT ' + token,
          felhasznalo: {
            id : felhasznalo._id,
            nev : felhasznalo.nev,
            felhasznalonev: felhasznalo.felhasznalonev,
            email : felhasznalo.email,
            pontszam : felhasznalo.pontszam,
            admin : felhasznalo.admin
          }
        });
      }
      else {
        return res.json({succes: false, msg: "Wrong password!!!"});
      }

    });
  });
});

 //profil oldal
 router.get('/profile',passport.authenticate('jwt', {session: false} ), (req ,res, next) =>{
   res.json({felhasznalo: req.user});
 });

 //leaderboard oldal
 router.get('/leaderboard'), (req ,res, next) =>{
   const query ="{pontszam :{$gte : 0}}).sort({ pontszam : -1 }";
   const rendez = "{ pontszam : -1 }";
  res.json(User.find(query).sort(rendez));
 };


module.exports = router;
